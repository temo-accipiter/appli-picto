@charset 'UTF-8';
@use 'sass:map';
@use 'tokens' as *; // Includes: opacity(), z-index(), spacing(), line-height(), transition()
@use 'colors' as *; // Includes: color(), surface(), semantic(), blue(), red(), etc.
@use 'size' as *; // Includes: size()
@use 'radius' as *; // Includes: radius()
@use 'typography' as *; // Includes: font-size(), font-weight()

/// ============================================================================
/// FORMS SYSTEM - Wrapper pur pour formulaires accessibles
/// ============================================================================
/// ✅ CONFORME TOKENS-FIRST : Toutes les valeurs proviennent de tokens
/// Ce fichier NE DÉFINIT AUCUNE donnée, il expose uniquement des fonctions wrapper.
///
/// SOURCES DE VÉRITÉ :
///   - $size-tokens dans _tokens.scss (touch targets)
///   - $spacing-tokens dans _tokens.scss (paddings, margins)
///   - $font-size-tokens dans _tokens.scss (tailles texte)
///   - $radius-tokens dans _tokens.scss (border-radius)
///   - $surface-color-tokens dans _tokens.scss (backgrounds, borders)
///   - $semantic-tokens dans _tokens.scss (error, warning, success)
///   - $primary-color-tokens dans _tokens.scss (couleurs primaires)
///
/// Usage:
///   height: form-height('md');              // 2.75rem (44px)
///   padding: form-padding('md');            // 1rem
///   background-color: form-bg('hover');     // surface hover
///   border-color: form-border-color('error'); // semantic error
///
/// Migration v2.1:
///   - ✅ Supprimé toutes variables individuelles ($form-control-height, etc.)
///   - ✅ Supprimé toutes maps locales ($form-heights-scale, etc.)
///   - ✅ Fonctions lisent uniquement depuis tokens
///   - ✅ Mixins adaptés pour utiliser fonctions
/// ============================================================================

/// ============================================================================
/// FUNCTIONS - Accesseurs pour formulaires
/// ============================================================================

/// Récupère une hauteur de contrôle formulaire (touch target accessible)
/// @param {String} $size - Taille du contrôle ('sm', 'md', 'lg')
/// @return {Length} Hauteur du contrôle (rem)
/// @example
///   height: form-height('md');  // 2.75rem (44px - WCAG AA touch target)
///   height: form-height('lg');  // 3.5rem (56px - TSA-preferred optimal)
@function form-height($size: 'md') {
  $heights: (
    'sm': spacing('36'),
    // 2.25rem (36px) - Minimum mobile
    'md': size('touch-target-min'),
    // 2.75rem (44px) - WCAG AA
    'lg': size('touch-target-preferred'),
    // 3.5rem (56px) - TSA-preferred (optimal large touch target)
  );

  @if not map.has-key($heights, $size) {
    @error "Form height size '#{$size}' not found. Available: sm, md, lg";
  }

  @return map.get($heights, $size);
}

/// Récupère un padding pour contrôle formulaire
/// @param {String} $size - Taille du padding ('sm', 'md', 'lg')
/// @return {Length} Padding horizontal (rem)
/// @example
///   padding: 0 form-padding('md');  // 1rem
@function form-padding($size: 'md') {
  $paddings: (
    'sm': spacing('sm'),
    // 0.5rem
    'md': spacing('16'),
    // 1rem
    'lg': spacing('20'),
    // 1.25rem
  );

  @if not map.has-key($paddings, $size) {
    @error "Form padding size '#{$size}' not found. Available: sm, md, lg";
  }

  @return map.get($paddings, $size);
}

/// Récupère une taille de police pour contrôle formulaire
/// @param {String} $size - Taille de police ('sm', 'md', 'lg')
/// @return {Length} Font-size (rem)
/// @example
///   font-size: form-font-size('md');  // 1rem (16px)
@function form-font-size($size: 'md') {
  $sizes: (
    'sm': font-size('sm'),
    // 0.875rem (14px)
    'md': font-size('base'),
    // 1rem (16px)
    'lg': font-size('lg'),
    // 1.125rem (18px)
  );

  @if not map.has-key($sizes, $size) {
    @error "Form font-size '#{$size}' not found. Available: sm, md, lg";
  }

  @return map.get($sizes, $size);
}

/// Récupère un border-radius pour contrôle formulaire
/// @param {String} $context - Contexte du contrôle ('input', 'button', 'radio', 'pill', 'sm', 'lg')
/// @return {Length|Percentage} Border-radius (px ou %)
/// @example
///   border-radius: form-radius('input');  // 8px
///   border-radius: form-radius('radio');  // 50%
@function form-radius($context: 'input') {
  $radii: (
    'input': radius('input'),
    // 8px (standard input)
    'button': radius('button'),
    // 8px (standard button)
    'radio': radius('full'),
    // 50% (cercle)
    'pill': radius('full'),
    // 50% (pilule)
    'sm': radius('sm'),
    // 4px
    'lg': radius('lg'),
    // 16px
  );

  @if not map.has-key($radii, $context) {
    @error "Form radius context '#{$context}' not found. Available: input, button, radio, pill, sm, lg";
  }

  @return map.get($radii, $context);
}

/// Récupère une couleur de bordure pour état de formulaire
/// @param {String} $state - État du contrôle ('default', 'hover', 'focus', 'error', 'disabled')
/// @return {Color} Couleur de bordure
/// @example
///   border-color: form-border-color('focus');  // #0077c2
///   border-color: form-border-color('error');  // semantic error
@function form-border-color($state: 'default') {
  $colors: (
    'default': surface('border'),
    // #e1e1e1 (bordure neutre)
    'hover': blue(200),
    // #bfdbfe (bleu clair hover)
    'focus': color('base'),
    // #0077c2 (bleu primaire focus)
    'error': semantic('error', 'base'),
    // #ef4444 (rouge error)
    'disabled': surface('border'),
    // #e1e1e1 (bordure neutre)
  );

  @if not map.has-key($colors, $state) {
    @error "Form border-color state '#{$state}' not found. Available: default, hover, focus, error, disabled";
  }

  @return map.get($colors, $state);
}

/// Récupère une couleur de background pour état de formulaire
/// @param {String} $state - État du contrôle ('default', 'hover', 'focus', 'disabled', 'error-bg')
/// @return {Color} Couleur de background
/// @example
///   background-color: form-bg('hover');     // #f9fafb
///   background-color: form-bg('error-bg');  // rgba error background
@function form-bg($state: 'default') {
  $colors: (
    'default': surface('bg'),
    // #ffffff (blanc pur)
    'hover': surface('hover'),
    // #f9fafb (gris très clair)
    'focus': surface('soft'),
    // #f8fafc (gris doux)
    'disabled': surface('soft'),
    // #f8fafc (gris doux)
    'error-bg': semantic('error', 'bg'),
    // rgba(239, 68, 68, 0.08)
  );

  @if not map.has-key($colors, $state) {
    @error "Form background state '#{$state}' not found. Available: default, hover, focus, disabled, error-bg";
  }

  @return map.get($colors, $state);
}

/// Récupère la largeur du focus ring accessible
/// @return {Length} Largeur du focus ring (px)
/// @example
///   box-shadow: 0 0 0 form-focus-ring-width() ...;
@function form-focus-ring-width() {
  @return 2px; // Standard WCAG AA focus indicator
}

/// Récupère la couleur du focus ring accessible
/// @return {Color} Couleur du focus ring (rgba)
/// @example
///   box-shadow: 0 0 0 2px form-focus-ring-color();
@function form-focus-ring-color() {
  // Utilise couleur primaire avec opacity 30%
  @return rgba(0, 119, 194, 0.3); // Primary blue with transparency
}

/// ============================================================================
/// MIXINS - Helpers pour formulaires accessibles
/// ============================================================================

/// Applique le style de base pour input/select/textarea
/// @param {String} $size - 'sm', 'md', 'lg'
@mixin form-control($size: 'md') {
  display: block;
  width: 100%;
  padding: form-padding($size);
  font-size: form-font-size($size);
  line-height: line-height('snug');
  font-family: var(--font-family-lexend);
  color: var(--color-text);
  background-color: form-bg('default');
  border: 1px solid form-border-color('default');
  border-radius: form-radius('input');
  transition: all timing('xs') easing('smooth');

  &:hover:not(:disabled) {
    background-color: form-bg('hover');
    border-color: form-border-color('hover');
  }

  &:focus-visible {
    outline: none;
    background-color: form-bg('focus');
    border-color: form-border-color('focus');
    box-shadow: 0 0 0 form-focus-ring-width() form-focus-ring-color();
  }

  &:disabled {
    background-color: form-bg('disabled');
    border-color: form-border-color('disabled');
    opacity: opacity('disabled');
    cursor: not-allowed;
  }

  // Error state
  &[aria-invalid='true'],
  &.error,
  &.is-invalid {
    border-color: form-border-color('error');
    background-color: form-bg('error-bg');

    &:focus-visible {
      box-shadow: 0 0 0 form-focus-ring-width()
        rgba(239, 68, 68, 0.3); // Error focus ring
    }
  }
}

/// Applique height pour control (input, select, button)
/// @param {String} $size - 'sm', 'md', 'lg'
@mixin form-control-height($size: 'md') {
  height: form-height($size);
  display: flex;
  align-items: center;
}

/// Applique padding pour control
/// @param {String} $size - 'sm', 'md', 'lg'
@mixin form-control-padding($size: 'md') {
  padding: 0 form-padding($size);
}

/// Applique border-radius pour control
/// @param {String} $context - 'input', 'button', 'radio', 'pill'
@mixin form-control-radius($context: 'input') {
  border-radius: form-radius($context);
}

/// Focus ring accessible
@mixin form-focus-ring {
  outline: none;
  box-shadow: 0 0 0 form-focus-ring-width() form-focus-ring-color();
}

/// Input placeholder style
@mixin form-placeholder {
  color: var(--color-border);
  opacity: opacity('full');

  &::placeholder {
    color: var(--color-border);
    opacity: opacity('high');
  }
}

/// Label style (accessible)
@mixin form-label {
  display: block;
  font-size: form-font-size('sm');
  font-weight: font-weight('medium');
  margin-bottom: spacing('sm');
  color: var(--color-text);
  font-family: var(--font-family-lexend);

  &[aria-required='true']::after,
  &.required::after {
    content: ' *';
    color: form-border-color('error');
  }
}

/// Error message style
@mixin form-error {
  font-size: font-size('xs');
  color: form-border-color('error');
  margin-top: spacing('xs');
  display: block;
}

/// Helper text style
@mixin form-helper-text {
  font-size: font-size('xs');
  color: var(--color-border);
  margin-top: spacing('xs');
  display: block;
}

/// Checkbox/Radio base style
@mixin form-checkbox-radio {
  margin: 0;
  margin-right: spacing('sm');
  cursor: pointer;
  accent-color: color('base');

  &:disabled {
    cursor: not-allowed;
    opacity: opacity('medium');
  }
}

// =============================================================================
// CSS CUSTOM PROPERTIES - Pour accès runtime JavaScript
// =============================================================================

:root {
  // === Dimensions ===
  --form-control-height: #{form-height('md')};
  --form-control-height-sm: #{form-height('sm')};
  --form-control-height-lg: #{form-height('lg')};
  --form-control-padding-x: #{form-padding('md')};

  // === Colors ===
  --form-control-border: #{form-border-color('default')};
  --form-control-border-focus: #{form-border-color('focus')};
  --form-control-border-error: #{form-border-color('error')};
  --form-control-bg: #{form-bg('default')};
  --form-control-bg-focus: #{form-bg('focus')};
  --form-control-bg-disabled: #{form-bg('disabled')};

  // === Radius ===
  --form-control-radius: #{form-radius('input')};
}

// ============================================================================
// GUIDELINES & BEST PRACTICES
// ============================================================================
/// 1. JAMAIS hardcoder dimensions/couleurs dans formulaires
/// 2. Utiliser mixins @include form-control() pour inputs standards
/// 3. WCAG AA : height >= 44px (form-height('md')) pour touch targets
/// 4. Focus ring OBLIGATOIRE : 2px minimum, couleur contrastée
/// 5. Labels accessibles : TOUJOURS associer <label for="id">
/// 6. Error handling : utiliser aria-invalid="true" pour screen readers
/// 7. Placeholder vs label : JAMAIS utiliser UNIQUEMENT placeholder
/// 8. Font TSA-friendly : Lexend pour labels/buttons (dyslexie)
/// 9. Contraste couleurs : 4.5:1 pour labels, 3:1 pour helpers (WCAG AA)
/// 10. Spacing : gap minimum spacing('sm') entre label et input
/// 11. Responsive : form-control adapte taille (sm, md, lg)
///
/// EXEMPLES :
///
/// ✅ CORRECT :
///   input { @include form-control('md'); }
///   button { height: form-height('lg'); }
///   .radio { border-radius: form-radius('radio'); }
///   .error-msg { @include form-error; }
///
/// ❌ INCORRECT :
///   input { height: 44px; }                  // Hardcodé !
///   button { background: #f9f9f9; }          // Hardcodé !
///   .radio { border-radius: 50%; }           // Hardcodé !
///   .error-msg { color: #f44336; }           // Hardcodé !
/// ============================================================================
