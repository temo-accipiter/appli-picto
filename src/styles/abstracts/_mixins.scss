@use 'breakpoints' as *;
@use 'a11y-tokens' as *;
@use 'borders' as *;
@use 'size' as *;
@use 'colors';
@use 'spacing';
@use 'typography';
@use 'shadows';
@use 'radius';
@use 'motion';
@use 'sass:map';
@use 'sass:meta';

/// Applique une version foncée d'une couleur au hover
/// @param {Color} $color Couleur de base
/// @param {Number} $amount Pourcentage de fonçage (par défaut 10%)

/// ==============================================
///  MIXINS UTILES POUR DESIGN MODULAIRE ET RÉACTIF
/// ==============================================

@mixin hover-darken($color, $amount: 10%) {
  &:hover {
    background-color: color.adjust($color, $lightness: -$amount);
  }
}

/// ============================================
/// BREAKPOINTS & MEDIA QUERIES
/// ============================================
/// Le mixin respond-to() et la map $breakpoints sont maintenant dans :
/// @see src/styles/abstracts/_breakpoints.scss
///
/// RÈGLE MOBILE-FIRST APPLI-PICTO :
/// TOUJOURS utiliser respond-to() avec min-width
/// JAMAIS utiliser max-width (desktop-first interdit)
///
/// Breakpoints disponibles :
/// - sm  : 576px  (Mobile landscape / Petites tablettes)
/// - md  : 768px  (Tablettes portrait)
/// - lg  : 1024px (Desktop / Tablettes landscape)
/// - xl  : 1200px (Large desktop)
/// - xxl : 1536px (Extra large desktop)
///
/// Usage :
/// @include respond-to(md) { ... }
/// ============================================

/// Clearfix pour les éléments flottants
@mixin clearfix {
  &::after {
    content: '';
    display: block;
    clear: both;
  }
}

/// Centre un conteneur en flex
@mixin flex-center {
  display: flex;
  justify-content: center;
  align-items: center;
}

/// Applique un style sur l'élément et ses états focus/hover/active
/// @param {Boolean} $self Si true, inclut aussi la règle de base (&)
@mixin on-event($self: false) {
  @if $self {
    &,
    &:hover,
    &:active,
    &:focus,
    &:focus-within {
      @content;
    }
  } @else {
    &:hover,
    &:active,
    &:focus,
    &:focus-within {
      @content;
    }
  }
}

/// Applique un focus state accessible (TSA-friendly)
/// @param {Color} $color Couleur du focus (défaut: primary)
@mixin focus-accessible($color: colors.color('base')) {
  &:focus-visible {
    outline: spacing.spacing('2') solid $color;
    outline-offset: spacing.spacing('2');
    @content;
  }
}

/// Focus ring unifié pour tous les éléments interactifs (WCAG 2.2 AA)
/// Utilise color-accent par défaut pour une cohérence visuelle
/// @param {Color} $color Couleur du ring (défaut: color-accent)
/// @param {String|Number} $width Épaisseur du ring (défaut: 'focus' = 2px)
/// @param {String|Number} $offset Offset du ring (défaut: 'focus' = 2px)
@mixin focus-ring($color: colors.color('base', 'accent'), $width: 'focus', $offset: 'focus') {
  &:focus {
    outline: none; // Reset pour éviter double outline
  }

  &:focus-visible {
    $resolved-width: if(
      meta.type-of($width) == 'string',
      border-width($width),
      $width
    );
    $resolved-offset: if(
      meta.type-of($offset) == 'string',
      border-width($offset),
      $offset
    );
    outline: $resolved-width solid $color;
    outline-offset: $resolved-offset;
  }
}

/// Touch target minimum conforme WCAG 2.2 AA + TSA friendly
/// Applique min-width/min-height selon la taille demandée
/// @param {String} $size - Taille du touch target ('preferred' | 'min' | 'optimal')
///   - 'preferred': 56px (recommandé TSA - enfants)
///   - 'min': 44px (minimum WCAG 2.2 AA)
///   - 'optimal': 48px (compromis UX)
///
/// @example scss - Touch target préféré (défaut, 56px)
///   .btn { @include touch-target(); }
///
/// @example scss - Touch target minimum (44px)
///   .small-icon-btn { @include touch-target('min'); }
///
/// @example scss - Touch target optimal (48px)
///   .card-action { @include touch-target('optimal'); }
@mixin touch-target($size: 'preferred') {
  @if $size == 'preferred' {
    min-width: a11y('preferred-touch-target');
    min-height: a11y('preferred-touch-target');
  } @else if $size == 'min' {
    min-width: a11y('min-touch-target');
    min-height: a11y('min-touch-target');
  } @else if $size == 'optimal' {
    min-width: a11y('optimal-touch-target');
    min-height: a11y('optimal-touch-target');
  } @else {
    @warn "Touch target size '#{$size}' unknown. Use 'preferred', 'min', or 'optimal'. Defaulting to 'preferred'.";
    min-width: a11y('preferred-touch-target');
    min-height: a11y('preferred-touch-target');
  }
}

/// Focus ring non-invasif utilisant box-shadow au lieu de outline
/// Meilleur pour design moderne, sans perturber layout (pas de outline-offset bugs)
/// Utilise les tokens a11y pour width/offset conformes WCAG 2.2 AA
///
/// @param {Color} $color - Couleur du focus ring (défaut: var(--focus-ring-color))
///
/// @example scss - Focus ring par défaut
///   .input { @include non-invasive-focus(); }
///
/// @example scss - Focus ring avec couleur custom
///   .btn-primary { @include non-invasive-focus(colors.color('base')); }
@mixin non-invasive-focus($color: var(--focus-ring-color)) {
  &:focus-visible {
    outline: none;
    box-shadow: 0 0 0 a11y('focus-ring-width') $color;
    outline-offset: a11y('focus-ring-offset');
  }

  // Remove default focus outline (avoid double outline)
  &:focus {
    outline: none;
  }
}

/// Cible un composant lorsqu’il est à l’intérieur d’un contexte donné
/// @param {String} $context Sélecteur du contexte parent
@mixin when-inside($context) {
  #{$context} & {
    @content;
  }
}

/// Applique une transition douce générique
@mixin transition-smooth {
  transition: all motion.timing('base') ease-in-out;
}

/// Style de base pour une carte ou un conteneur avec fond
@mixin card-style {
  background-color: var(--color-surface);
  color: var(--color-text);
  border-radius: radius.radius('md');
  box-shadow: shadows.shadow('sm');
  padding: spacing.spacing('md');
}

/// Cache visuellement un élément (accessibilité)
@mixin visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/// Transition sécurisée respectant prefers-reduced-motion (WCAG 2.3.3)
/// Important pour les utilisateurs TSA sensibles aux mouvements
@mixin safe-transition(
  $property: all,
  $duration: motion.timing('fast'),
  $easing: ease
) {
  transition: $property $duration $easing;

  @media (prefers-reduced-motion: reduce) {
    transition: none;
  }
}

/// Animation sécurisée respectant prefers-reduced-motion
@mixin safe-animation(
  $name,
  $duration: motion.timing('base'),
  $timing: ease-in-out
) {
  animation: $name $duration $timing;

  @media (prefers-reduced-motion: reduce) {
    animation: none;
  }
}

/// Zone interactive minimum WCAG 2.2 AA (44x44px)
@mixin interactive-target {
  min-height: spacing('44');
  min-width: spacing('44');
}

// ============================================
// DND PATTERNS MIXINS (Drag & Drop)
// ============================================

/// Mixin pour zones droppables (DndSlot)
/// Gère les états : default, over, dragging-from
/// @param {Color} $border-color Couleur border au hover
/// @param {Color} $bg-color Couleur background au hover
/// @param {Length} $min-height Hauteur min de la zone
/// @example
///   @include dnd-slot(colors.color('base'), rgba(colors.color('base'), 0.08))
@mixin dnd-slot(
  $border-color: var(--color-primary),
  $bg-color: rgba(74, 144, 217, 0.08),
  $min-height: size('card-min-height')
) {
  min-height: $min-height;
  border: border-width('focus') dashed transparent;
  border-radius: radius.radius('md');
  background-color: transparent;
  padding: spacing.spacing('sm');
  @include safe-transition(border-color opacity, motion.timing('fast'), ease);

  // État : drag hover (over)
  &.dnd-slot--over,
  &--over {
    border-color: $border-color;
    background-color: $bg-color;
  }

  // État : dragging from this slot
  &.dnd-slot--dragging-from,
  &--dragging-from {
    border-color: $border-color;
    background-color: rgba($border-color, 0.04);
  }

  // Focus visible pour keyboard navigation
  &:focus-visible {
    outline: border-width('focus') solid $border-color;
    outline-offset: -2px; // Valeur négative contextuelle (inset focus)
  }
}

/// Mixin pour grille DnD responsive (DndGrid)
/// Grille mobile-first avec auto-fill
/// @param {Length} $min-width Largeur min items (minmax)
/// @param {Length} $gap Gap entre items
/// @example
///   @include dnd-grid(260px, var(--spacing-md))
@mixin dnd-grid($min-width: 260px, $gap: var(--spacing-md)) {
  display: grid;
  grid-auto-flow: dense;

  // Mobile par défaut (320px-767px)
  grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  gap: var(--spacing-xs);

  // Tablette (768px+)
  @include respond-to(md) {
    grid-template-columns: repeat(auto-fill, minmax($min-width, 1fr));
    gap: var(--spacing-sm);
  }

  // Desktop (1024px+)
  @include respond-to(lg) {
    gap: $gap;
  }

  // État dragging global
  &.dnd-grid--dragging {
    opacity: 0.95;
  }
}

/// Alias pour dnd-layout (compatibilité future)
@mixin dnd-layout {
  @include dnd-grid;
}

// ============================================
// ADMIN PATTERNS MIXINS (Réutilisables)
// ============================================

/// Badge rôle utilisateur (admin, abonné, visitor, etc.)
/// Génère automatiquement gradient, couleurs, ombres depuis role-color()
/// @param {String} $role Nom du rôle (admin | abonne | visitor | free | staff)
/// @example
///   &[data-role='admin'] { @include role-badge(admin); }
@mixin role-badge($role) {
  $base-color: colors.role-color($role, 'base');
  $gradient-start: colors.role-color($role, 'gradient-start');
  $gradient-end: colors.role-color($role, 'gradient-end');

  background: linear-gradient(135deg, $gradient-end, $gradient-start);
  color: white;
  border-color: $base-color;
  box-shadow: 0 3px 10px rgba($gradient-end, 0.4);
  font-weight: typography.font-weight('semibold');
  padding: spacing.spacing('xs') spacing.spacing('md');
  border-radius: radius.radius('md');
  display: inline-flex;
  align-items: center;
  gap: spacing.spacing('xs');

  @include safe-transition(transform box-shadow, motion.timing('fast'), ease);

  &:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba($gradient-end, 0.5);
  }
}

/// Card admin avec header coloré et contenu
/// Pattern réutilisable pour QuotaManagement, AccountManagement, etc.
/// @param {Color} $header-color Couleur de fond du header (défaut: primary)
@mixin admin-card($header-color: colors.color('base')) {
  background: var(--color-surface);
  border-radius: radius.radius('lg');
  box-shadow: shadows.shadow('md');
  overflow: hidden;

  .card-header {
    background: linear-gradient(
      135deg,
      $header-color,
      color.adjust($header-color, $lightness: -10%)
    );
    color: white;
    padding: spacing.spacing('lg');
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: spacing.spacing('md');

    h2,
    h3 {
      margin: 0;
      font-weight: typography.font-weight('bold');
      display: flex;
      align-items: center;
      gap: spacing.spacing('sm');
    }
  }

  .card-body {
    padding: spacing.spacing('lg');
  }

  .card-footer {
    padding: spacing.spacing('md') spacing.spacing('lg');
    background: var(--color-bg-soft);
    border-top: border-width('thin') solid var(--color-border);
  }
}

/// Table admin responsive avec styles cohérents
/// Pattern pour AccountManagement, Logs, etc.
@mixin admin-table {
  width: 100%;
  border-collapse: collapse;
  background: var(--color-surface);
  border-radius: radius.radius('md');
  overflow: hidden;
  box-shadow: shadows.shadow('sm');

  thead {
    background: var(--color-bg-soft);
    border-bottom: border-width('focus') solid var(--color-border);

    th {
      padding: spacing.spacing('md');
      text-align: left;
      font-weight: typography.font-weight('semibold');
      color: var(--color-text);
      font-size: typography.font-size('sm');
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
  }

  tbody {
    tr {
      border-bottom: border-width('thin') solid var(--color-border);
      @include safe-transition(background-color, motion.timing('fast'), ease);

      &:hover {
        background: var(--color-bg-hover);
      }

      &:last-child {
        border-bottom: none;
      }
    }

    td {
      padding: spacing.spacing('md');
      vertical-align: middle;
    }
  }

  // Responsive : scroll horizontal sur mobile (mobile-first pattern)
  // Mobile par défaut : table scrollable
  display: block;
  overflow-x: auto;
  white-space: nowrap;

  // Tablette+ (768px+) : table normale
  @include respond-to(md) {
    display: table;
    overflow-x: visible;
    white-space: normal;
  }
}

/// Button action admin (éditer, supprimer, etc.)
/// @param {Color} $color Couleur du bouton (défaut: primary)
/// @param {String} $variant solid | outline | ghost
@mixin admin-action-button($color: colors.color('base'), $variant: 'solid') {
  padding: spacing.spacing('xs') spacing.spacing('md');
  border-radius: radius.radius('sm');
  font-size: typography.font-size('sm');
  font-weight: typography.font-weight('medium');
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: spacing.spacing('xs');
  border: border-width('thin') solid transparent;
  @include safe-transition(all, motion.timing('fast'), ease);

  @if $variant == 'solid' {
    background: $color;
    color: white;
    border-color: $color;

    &:hover:not(:disabled) {
      background: color.adjust($color, $lightness: -10%);
      transform: translateY(-1px);
      box-shadow: shadows.shadow('sm');
    }
  } @else if $variant == 'outline' {
    background: transparent;
    color: $color;
    border-color: $color;

    &:hover:not(:disabled) {
      background: rgba($color, 0.1);
      border-color: color.adjust($color, $lightness: -10%);
    }
  } @else if $variant == 'ghost' {
    background: transparent;
    color: $color;

    &:hover:not(:disabled) {
      background: rgba($color, 0.1);
    }
  }

  &:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  &:focus-visible {
    outline: border-width('focus') solid $color;
    outline-offset: border-width('focus');
  }
}

/// ============================================================================
/// VALIDATION GLOW - Input/Form Feedback Animation
/// ============================================================================
/// Mixin générique pour animations de validation (error/success)
/// Génère keyframe unique + applique animation TSA-compliant
/// @param {String} $type - Type de validation ('error' | 'success')
/// @param {Length} $blur - Rayon de blur (défaut: spacing('6'))
/// @param {Length} $spread - Spread de l'ombre (défaut: spacing('2'))
/// @example
///   .input--error { @include validation-glow('error'); }
///   .input--success { @include validation-glow('success'); }
/// ============================================================================
@mixin validation-glow(
  $type: 'error',
  $blur: spacing.spacing('6'),
  $spread: spacing.spacing('2')
) {
  $color: if($type == 'error', colors.semantic('error'), colors.semantic('success'));

  // Génération keyframe unique par type
  @keyframes glow-#{$type} {
    0% {
      box-shadow: none;
    }
    50% {
      box-shadow: 0 0 $blur $spread rgba($color, 0.5);
    }
    100% {
      box-shadow: none;
    }
  }

  // Application animation TSA-compliant
  animation: glow-#{$type} motion.timing('fast') motion.easing('ease-in-out');

  // Respect prefers-reduced-motion (WCAG 2.2 AA)
  @media (prefers-reduced-motion: reduce) {
    animation: none;
    // Fallback: ombre statique réduite
    box-shadow: 0 0 calc($blur * 0.5) calc($spread * 0.5) rgba($color, 0.3);
  }
}
