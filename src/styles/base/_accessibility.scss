@charset 'UTF-8';
@use '../abstracts' as *;
@use 'sass:color';

/// ============================================================================
/// ACCESSIBILITY - WCAG 2.2 AA Compliance
/// ============================================================================
/// Styles et helpers pour accessibilité conforme à WCAG AA.
/// Respecte préférences utilisateur (prefers-reduced-motion, prefers-color-scheme).
/// Optimisé pour enfants TSA (clear, predictable, calm design).
///
/// ✅ CONFORME TOKENS-FIRST : Toutes valeurs via fonctions tokens
/// ============================================================================

// =============================================================================
// FOCUS MANAGEMENT - Keyboard navigation
// =============================================================================

/// Supprime outline par défaut et applique focus ring custom
:focus-visible {
  outline: none;
  box-shadow:
    0 0 0 border-width('focus') var(--color-bg),
    0 0 0 spacing('4') var(--focus-ring-color);
}

/// Focus visible sur les inputs
input:focus-visible,
select:focus-visible,
textarea:focus-visible {
  outline: none;
  border-color: var(--focus-ring-color);
  box-shadow: 0 0 0 spacing('3') color.change(blue(500), $alpha: 0.1);
}

/// Focus visible sur buttons
button:focus-visible,
a:focus-visible,
[role='button']:focus-visible {
  outline: none;
  box-shadow:
    0 0 0 border-width('focus') var(--color-bg),
    0 0 0 spacing('4') var(--focus-ring-color);
}

/// Focus visible sur checkboxes et radios
input[type='checkbox']:focus-visible,
input[type='radio']:focus-visible {
  outline: border-width('focus') solid var(--focus-ring-color);
  outline-offset: border-width('focus');
}

// =============================================================================
// SCREEN READER ONLY TEXT - Accessible labels
// =============================================================================

/// Text visible uniquement aux lecteurs d'écran
.sr-only,
.visually-hidden {
  position: absolute !important;
  width: 1px !important; // Standard WCAG technique
  height: 1px !important; // Standard WCAG technique
  padding: 0 !important;
  margin: -1px !important;
  overflow: hidden !important;
  clip: rect(0, 0, 0, 0) !important;
  white-space: nowrap !important;
  border-width: 0 !important;
}

/// Interactive sr-only (pour skip links)
.sr-only:focus,
.visually-hidden:focus {
  position: static !important;
  width: auto !important;
  height: auto !important;
  padding: inherit !important;
  margin: inherit !important;
  overflow: visible !important;
  clip: auto !important;
  white-space: normal !important;
}

// =============================================================================
// SKIP NAVIGATION - Keyboard shortcut
// =============================================================================

/// Skip to main content link (first focusable element)
.skip-to-main {
  position: absolute;
  top: calc(-1 * size('touch-target-optimal'));
  left: 0;
  background: var(--color-primary);
  color: var(--color-text-invert);
  padding: spacing('sm') spacing('md');
  text-decoration: none;
  z-index: z-index('tooltip');

  &:focus {
    top: 0;
  }
}

// =============================================================================
// TEXT AND CONTRAST - WCAG AA requirement
// =============================================================================

/// Min line-height for readability (WCAG 1.5)
body {
  line-height: line-height('normal');
}

p,
li,
label {
  line-height: line-height('normal');
}

/// Text spacing - generous for dyslexia (TSA)
/// Letter spacing, word spacing, line height, paragraph spacing
body {
  letter-spacing: 0.02em; // Slight letterspacing for readability
  word-spacing: a11y('word-spacing-min');
}

h1,
h2,
h3,
h4,
h5,
h6 {
  letter-spacing: -0.02em; // Headings slightly tighter
}

// =============================================================================
// COLOR AND CONTRAST - Minimum 4.5:1 for normal text (WCAG AA)
// =============================================================================

/// Ensure minimum contrast ratios
/// Text on backgrounds: 4.5:1 (normal), 3:1 (large)
body {
  color: var(--color-text);
  background-color: var(--color-bg);
  // Contrast: Meets WCAG AA (dark text on light/light on dark)
}

/// Links - underline for clarity (not color alone)
a {
  text-decoration: underline;
  text-decoration-thickness: border-width('thin');
  text-underline-offset: spacing('4');

  &:visited {
    color: var(--color-primary);
  }
}

/// Text on colored backgrounds (must maintain 4.5:1)
.badge,
[role='badge'] {
  color: var(--color-text-invert);
  // Dark text on light badge, light on dark badge
}

// =============================================================================
// TOUCH TARGETS - Minimum 44x44px (WCAG AAA)
// =============================================================================

/// Interactive elements must be >= 44x44px
button,
a,
input[type='checkbox'],
input[type='radio'],
[role='button'],
[role='menuitem'] {
  min-width: a11y('min-touch-target');
  min-height: a11y('min-touch-target');
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

/// Touch target padding for smaller elements
a[href],
button,
input[type='button'],
input[type='submit'],
input[type='reset'],
input[type='checkbox'],
input[type='radio'] {
  // Already sized to 44x44 via mixin
  // Add padding to reach minimum if needed
}

/// Exception opt-out : Désactiver min-width/min-height pour composants spécifiques
/// ⚠️ UTILISER AVEC PRÉCAUTION : Réservé aux cas exceptionnels où design
/// compact est nécessaire (ex: boutons icônes Time Timer, badges compacts).
/// TOUJOURS vérifier que l'accessibilité tactile reste acceptable (min 40px recommandé).
.skip-min-touch-target {
  min-width: unset !important;
  min-height: unset !important;
}

// =============================================================================
// REDUCED MOTION - Accessibility first
// =============================================================================

/// Respect user preference for reduced motion (OS + app calm mode)
/// Already handled in _motion.scss, but duplication ensures coverage
@media (prefers-reduced-motion: reduce) {
  *,
  *::before,
  *::after {
    animation-duration: a11y('reduced-motion-duration') !important;
    animation-iteration-count: 1 !important;
    transition-duration: a11y('reduced-motion-duration') !important;
    scroll-behavior: auto !important;
  }
}

/// Calm mode override (app-specific)
[data-calm-mode='true'],
.calm-mode {
  * {
    animation-duration: a11y('reduced-motion-duration') !important;
    animation-iteration-count: 1 !important;
    transition-duration: a11y('reduced-motion-duration') !important;
  }
}

// =============================================================================
// FORCED COLORS MODE - High contrast windows mode
// =============================================================================

@media (forced-colors: active) {
  * {
    outline-width: border-width('thin');
  }

  button,
  a,
  input {
    outline: border-width('thin') solid currentColor;
  }

  ::selection {
    background-color: Highlight;
    color: HighlightText;
  }
}

// =============================================================================
// IMAGES AND ICONS - Alt text requirement
// =============================================================================

/// Ensure all images have alt text (validate in HTML)
/// This is enforcement for missing alt text (debugging)
img:not([alt]),
[role='img']:not([aria-label]):not([aria-labelledby]) {
  outline: border-width('focus') dashed semantic('error', 'base');
  outline-offset: border-width('focus');
  // Visible in dev - remove in prod if needed
}

// =============================================================================
// FORM LABELS - Always visible
// =============================================================================

/// Labels must always be visible (never placeholder-only)
label {
  display: block;
  margin-bottom: spacing('4');
  font-weight: font-weight('medium');
  color: var(--color-text);
}

/// Required field indicator
label[required]::after,
label[aria-required='true']::after {
  content: ' *';
  color: var(--color-error);
  aria-label: 'required';
}

/// Error messages visible and linked to input
[role='alert'],
.error-message {
  color: var(--color-error);
  font-size: font-size('sm');
  margin-top: spacing('4');
  display: block;
}

/// Disabled form controls
input:disabled,
select:disabled,
textarea:disabled {
  opacity: opacity('lg');
  cursor: not-allowed;
}

// =============================================================================
// TABLES - Accessibility structure
// =============================================================================

/// Table headers semantic
th {
  font-weight: font-weight('semibold');
  text-align: left;
  padding: spacing('sm') spacing('12');
  background-color: var(--color-surface);
  border-bottom: border-width('focus') solid var(--color-border);
}

td {
  padding: spacing('sm') spacing('12');
  border-bottom: border-width('thin') solid var(--color-border);
}

// =============================================================================
// HEADINGS - Hierarchy
// =============================================================================

/// Heading hierarchy (h1 > h2 > h3...)
/// Must use semantic tags, not divs with role
h1,
h2,
h3,
h4,
h5,
h6 {
  margin-top: 1em; // Relative spacing OK for typography flow
  margin-bottom: 0.5em;
  font-weight: font-weight('semibold');
  line-height: line-height('tight');
}

h1 {
  font-size: font-size('3xl');
}

h2 {
  font-size: font-size('2xl');
}

h3 {
  font-size: font-size('xl');
}

h4 {
  font-size: font-size('base');
}

h5,
h6 {
  font-size: font-size('sm');
}

// =============================================================================
// LISTS - Proper semantics
// =============================================================================

/// Ordered and unordered lists
ol,
ul {
  margin-left: 1.5em; // Relative spacing OK for lists
  margin-bottom: 1em;

  li {
    margin-bottom: 0.5em;
  }
}

// =============================================================================
// LANGUAGE IDENTIFICATION - i18n
// =============================================================================

/// Mark language changes (helps screen readers)
// HTML should have lang="fr" at document root
[lang] {
  // Content in different language - screen readers will switch
}

// =============================================================================
// LIVE REGIONS - Dynamic content
// =============================================================================

/// Live region for status updates (toasts, alerts)
[role='status'],
[role='alert'],
[aria-live] {
  // Already marked with ARIA - just ensure visibility
}

// =============================================================================
// MODAL DIALOGS - Proper semantics
// =============================================================================

[role='dialog'] {
  // Must trap focus within dialog
  // Must restore focus when dialog closes
  // Must have aria-labelledby or aria-label
}

// =============================================================================
// CAROUSEL / SLIDER - Keyboard navigation
// =============================================================================

[role='region'][aria-label*='carousel'],
[role='region'][aria-label*='slider'] {
  // Must support keyboard arrows
  // Must have pause button for auto-play
}

// =============================================================================
// GUIDELINES FOR IMPLEMENTATION
// =============================================================================

// ============================================================================
// WCAG 2.2 REQUIREMENTS CHECKLIST
// ============================================================================
// 1. PERCEIVED
//     Distinguishable:
//      - Color not sole means of conveying info (use labels + icons)
//      - Contrast >= 4.5:1 (normal), 3:1 (large text)
//      - Resize text up to 200% without loss of content
//      - Images of text avoided
//
// 2. OPERABLE
//     Keyboard accessible:
//      - All functionality available via keyboard
//      - No keyboard trap (except intentional like modals)
//      - Focus visible and in logical order
//      - Skip links for repetitive content
//     Enough time:
//      - No auto-play animations (or user can pause)
//      - Respect prefers-reduced-motion
//      - No time-limited interactions (or extend time)
//     Seizure prevention:
//      - No flashing > 3/sec
//      - No animated GIFs with strobes
//     Touch targets:
//      - >= 44x44px (WCAG AAA)
//      - >= 24x24px minimum (WCAG AA)
//
// 3. UNDERSTANDABLE
//     Readable:
//      - Page lang declared (html lang="fr")
//      - Avoid jargon, use clear language
//      - Lists structured semantically
//     Predictable:
//      - Consistent navigation
//      - Consistent component behavior
//      - No unexpected context changes
//     Input assistance:
//      - Clear labels (not just placeholder)
//      - Error detection & suggestions
//      - Confirmation for important actions
//
// 4. ROBUST
//     Compatible:
//      - Valid HTML markup
//      - Proper ARIA roles/attributes
//      - No conflicting ids
//      - Test with screen readers (NVDA, JAWS, VoiceOver)

// ============================================================================
// TSA SPECIFIC CONSIDERATIONS
// ============================================================================
// - Calm visual design (smooth animations, <0.3s)
// - Predictable, simple navigation
// - Clear visual hierarchy
// - Avoid sensory overload (reduce animations, clear focus)
// - High contrast text on buttons/links
// - Generous spacing between interactive elements
// - Clear feedback on interactions
// - Consistent terminology throughout app
// - Simple language, avoid idioms
// - Provide context and help text
