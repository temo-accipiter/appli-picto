@use '@styles/abstracts' as *;
@use 'sass:color';
@use 'sass:map';

// src/components/features/time-timer/TimeTimer.scss

// =============================================================================
// LOCAL MIXINS (DRY Pattern)
// =============================================================================

/// Applique un gradient UI défini dans les tokens
/// @param {String} $name - Nom du gradient dans $ui-gradients
@mixin _local-gradient($name) {
  $gradient: ui-gradient($name);
  background: linear-gradient(
    135deg,
    map.get($gradient, start) 0%,
    map.get($gradient, end) 100%
  );
}

// =============================================================================
// COMPONENT STYLES
// =============================================================================

.time-timer {
  // Layout & Spacing
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: spacing('xl');
  padding: spacing('xl');

  // Appearance
  @include _local-gradient('blue-soft');
  border-radius: radius('lg');

  // Shadow constructed from tokens: 0 4px 12px rgba(slate-900, 0.08)
  box-shadow: 0 spacing('4') spacing('12')
    #{color.change(slate(900), $alpha: opacity('0-08'))};

  // --- Modifiers (BEM) ---

  // Mode plein écran
  &--full {
    min-height: spacing('600');
    max-width: spacing('600');
    margin: 0 auto;
  }

  // Mode compact
  &--compact {
    max-width: spacing('300');
    padding: spacing('lg');
    gap: spacing('md');
  }

  // --- Elements (BEM) ---

  &__circle-container {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    max-width: spacing('280');

    @include when-inside('.time-timer--compact') {
      max-width: spacing('160');
    }
  }

  &__circle {
    width: 100%;
    height: auto;
    // Drop shadow soft
    filter: drop-shadow(
      0 spacing('2') spacing('8')
        #{color.change(slate(900), $alpha: opacity('sm'))}
    );
  }

  &__circle-bg {
    opacity: opacity('lg');
  }

  &__circle-progress {
    // Usage strict de timing() et easing()
    transition: stroke timing('base') easing('smooth');

    @include when-inside('.time-timer--compact') {
      stroke-width: 10; // SVG unitless prop controlled by CSS usually needs check, keeping as is but cautious
    }
  }

  &__time-display {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: spacing('xs');
    text-align: center;
  }

  &__time-text {
    // Usage de font-size() et font-weight()
    font-size: font-size('5xl');
    font-weight: font-weight('bold');
    color: text('default');
    line-height: line-height('none'); // 1
    font-variant-numeric: tabular-nums;

    @include when-inside('.time-timer--compact') {
      font-size: font-size('xl');
    }
  }

  &__duration-label {
    font-size: font-size('sm');
    color: slate(600); // Remplacement de gray() par slate() (modern)
    font-weight: font-weight('medium');
  }

  &__controls {
    display: flex;
    gap: spacing('md');
    flex-wrap: wrap;
    justify-content: center;
  }

  &__btn {
    display: flex;
    align-items: center;
    gap: spacing('xs');
    padding: spacing('md') spacing('lg');
    border: none;
    border-radius: radius('md');
    font-size: font-size('base');
    font-weight: font-weight('semibold');
    cursor: pointer;

    // Transition tokenisée
    @include safe-transition(all, timing('base'), easing('smooth'));

    box-shadow: 0 spacing('2') spacing('4')
      #{color.change(slate(900), $alpha: opacity('sm'))};

    @include when-inside('.time-timer--compact') {
      padding: spacing('sm') spacing('md');
      font-size: font-size('sm');
    }

    // Interactive States
    &:hover:not(:disabled) {
      transform: translateY(-#{spacing('2')});
      box-shadow: 0 spacing('4') spacing('8')
        #{color.change(slate(900), $alpha: opacity('md'))};
    }

    &:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 spacing('2') spacing('4')
        #{color.change(slate(900), $alpha: opacity('sm'))};
    }

    &:disabled {
      opacity: opacity('half');
      cursor: not-allowed;
    }

    // A11y Focus
    @include non-invasive-focus(semantic('info-primary'));

    // Variant: Primary
    &--primary {
      @include _local-gradient('purple-modern');
      color: text('invert');

      &:hover:not(:disabled) {
        @include _local-gradient('purple-modern-hover');
      }
    }

    // Variant: Secondary
    &--secondary {
      background: surface('bg');
      color: text('default');
      border: border-width('base') solid slate(300);

      &:hover:not(:disabled) {
        background: slate(100);
        border-color: slate(400);
      }
    }
  }

  &__icon {
    font-size: font-size('lg');
    line-height: line-height('none');

    @include when-inside('.time-timer--compact') {
      font-size: font-size('base');
    }
  }

  // --- Settings Panel ---

  &__settings {
    width: 100%;
    padding: spacing('lg');
    background: surface('bg');
    border-radius: radius('md');
    border: border-width('base') solid slate(200);

    // Animation via motion tokens
    animation: slide-up timing('base') easing('smooth');
  }

  &__settings-title {
    margin: 0 0 spacing('md') 0;
    font-size: font-size('lg');
    font-weight: font-weight('semibold');
    color: text('default');
    text-align: center;
  }

  &__preset-grid {
    display: grid;
    // Remplacement du 80px hardcodé par spacing('80')
    grid-template-columns: repeat(auto-fit, minmax(spacing('80'), 1fr));
    gap: spacing('sm');

    @include when-inside('.time-timer--compact') {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  &__preset-btn {
    padding: spacing('md');
    border: border-width('base') solid slate(300);
    border-radius: radius('sm');
    background: surface('bg');
    color: text('default');
    font-size: font-size('base');
    font-weight: font-weight('medium');
    cursor: pointer;
    @include safe-transition(all, timing('fast'), easing('smooth'));

    &:hover {
      background: slate(100);
      border-color: color('base');
      transform: translateY(-#{spacing('2')});
    }

    &:active {
      transform: translateY(0);
    }

    @include non-invasive-focus(semantic('info-primary'));

    &--active {
      @include _local-gradient('purple-modern');
      color: text('invert');
      border-color: transparent;
      font-weight: font-weight('bold');
      animation: pop timing('base') easing('smooth');

      &:hover {
        @include _local-gradient('purple-modern-hover');
      }
    }
  }
}

// Utility class (should ideally be global, but kept if local specific needed)
.sr-only {
  @include visually-hidden;
}

// =============================================================================
// RUNTIME EXPORTS (:root)
// =============================================================================
// Note: Ces variables servent au code JS (React) pour colorer le SVG.
// On mappe ici les tokens SCSS vers des CSS vars locales.

:root {
  --color-success: #{semantic('success')};
  --color-warning: #{semantic('warning')};
  --color-danger: #{semantic('error')};
  --color-gray-light: #{slate(200)};
}

// =============================================================================
// ACCESSIBILITY (Reduced Motion)
// =============================================================================

@media (prefers-reduced-motion: reduce) {
  .time-timer {
    &__circle-progress,
    &__btn,
    &__preset-btn {
      transition: none;
    }

    &__btn:hover:not(:disabled),
    &__preset-btn:hover {
      transform: none;
    }

    &__preset-btn--active,
    &__settings {
      animation: none;
    }
  }
}
