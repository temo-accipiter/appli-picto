[
  {
    "table_report": {
      "table": {
        "schema": "public",
        "name": "user_roles"
      },
      "columns": [
        {
          "column_name": "id",
          "data_type": "uuid",
          "is_nullable": "NO",
          "default": "gen_random_uuid()"
        },
        {
          "column_name": "user_id",
          "data_type": "uuid",
          "is_nullable": "NO",
          "default": null
        },
        {
          "column_name": "role_id",
          "data_type": "uuid",
          "is_nullable": "NO",
          "default": null
        },
        {
          "column_name": "is_active",
          "data_type": "boolean",
          "is_nullable": "NO",
          "default": "true"
        },
        {
          "column_name": "created_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "NO",
          "default": "now()"
        },
        {
          "column_name": "updated_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "NO",
          "default": "now()"
        },
        {
          "column_name": "assigned_by",
          "data_type": "uuid",
          "is_nullable": "YES",
          "default": null
        },
        {
          "column_name": "assigned_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "YES",
          "default": "now()"
        },
        {
          "column_name": "expires_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "YES",
          "default": null
        }
      ],
      "rls": {
        "rls_enabled": true,
        "rls_forced": false
      },
      "policies": [
        {
          "policyname": "Users can view own user_roles",
          "command": "SELECT",
          "roles": [
            "authenticated"
          ],
          "using": "(auth.uid() = user_id)",
          "with_check": null
        },
        {
          "policyname": "user_roles_admin_all",
          "command": "ALL",
          "roles": [
            "authenticated"
          ],
          "using": "is_admin()",
          "with_check": "is_admin()"
        },
        {
          "policyname": "user_roles_select_own",
          "command": "SELECT",
          "roles": [
            "authenticated"
          ],
          "using": "(user_id = auth.uid())",
          "with_check": null
        },
        {
          "policyname": "users_can_self_assign_basic_roles",
          "command": "INSERT",
          "roles": [
            "authenticated"
          ],
          "using": null,
          "with_check": "((user_id = auth.uid()) AND (role_id IN ( SELECT roles.id\n   FROM roles\n  WHERE ((roles.name = ANY (ARRAY['free'::text, 'visitor'::text])) AND (roles.is_active = true)))))"
        },
        {
          "policyname": "users_can_update_own_basic_roles",
          "command": "UPDATE",
          "roles": [
            "authenticated"
          ],
          "using": "(user_id = auth.uid())",
          "with_check": "((user_id = auth.uid()) AND (role_id IN ( SELECT roles.id\n   FROM roles\n  WHERE ((roles.name = ANY (ARRAY['free'::text, 'visitor'::text])) AND (roles.is_active = true)))))"
        }
      ],
      "indexes": [
        {
          "name": "idx_user_roles_expires_at",
          "def": "CREATE INDEX idx_user_roles_expires_at ON public.user_roles USING btree (expires_at)"
        },
        {
          "name": "idx_user_roles_expiring_active",
          "def": "CREATE INDEX idx_user_roles_expiring_active ON public.user_roles USING btree (expires_at) WHERE (is_active = true)"
        },
        {
          "name": "idx_user_roles_is_active",
          "def": "CREATE INDEX idx_user_roles_is_active ON public.user_roles USING btree (is_active)"
        },
        {
          "name": "idx_user_roles_role_active",
          "def": "CREATE INDEX idx_user_roles_role_active ON public.user_roles USING btree (role_id, is_active)"
        },
        {
          "name": "idx_user_roles_role_id",
          "def": "CREATE INDEX idx_user_roles_role_id ON public.user_roles USING btree (role_id)"
        },
        {
          "name": "idx_user_roles_user_active",
          "def": "CREATE INDEX idx_user_roles_user_active ON public.user_roles USING btree (user_id, is_active)"
        },
        {
          "name": "idx_user_roles_user_id",
          "def": "CREATE INDEX idx_user_roles_user_id ON public.user_roles USING btree (user_id)"
        },
        {
          "name": "user_roles_pkey",
          "def": "CREATE UNIQUE INDEX user_roles_pkey ON public.user_roles USING btree (id)"
        },
        {
          "name": "user_roles_user_id_role_id_key",
          "def": "CREATE UNIQUE INDEX user_roles_user_id_role_id_key ON public.user_roles USING btree (user_id, role_id)"
        }
      ],
      "constraints": [
        {
          "name": "user_roles_assigned_by_fkey",
          "type": "f",
          "definition": "FOREIGN KEY (assigned_by) REFERENCES auth.users(id) ON DELETE SET NULL"
        },
        {
          "name": "user_roles_pkey",
          "type": "p",
          "definition": "PRIMARY KEY (id)"
        },
        {
          "name": "user_roles_role_id_fkey",
          "type": "f",
          "definition": "FOREIGN KEY (role_id) REFERENCES roles(id) ON DELETE CASCADE"
        },
        {
          "name": "user_roles_user_id_fkey",
          "type": "f",
          "definition": "FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE"
        },
        {
          "name": "user_roles_user_id_role_id_key",
          "type": "u",
          "definition": "UNIQUE (user_id, role_id)"
        }
      ],
      "triggers": [
        {
          "name": "audit_user_roles_changes",
          "enabled": "O",
          "definition": "CREATE TRIGGER audit_user_roles_changes AFTER INSERT OR DELETE OR UPDATE ON user_roles FOR EACH ROW EXECUTE FUNCTION tg_audit_permission_change()",
          "function_name": "tg_audit_permission_change"
        },
        {
          "name": "set_user_roles_updated_at",
          "enabled": "O",
          "definition": "CREATE TRIGGER set_user_roles_updated_at BEFORE UPDATE ON user_roles FOR EACH ROW EXECUTE FUNCTION set_updated_at()",
          "function_name": "set_updated_at"
        }
      ],
      "data_preview": [
        {
          "id": "8ff2163c-c1ea-4a0c-8b81-cdc57eee46c5",
          "user_id": "fbe8d0fe-347d-4b32-86f1-af640f75a307",
          "role_id": "5d4e21cf-39f5-43f8-8ce6-6680f68f4d22",
          "is_active": true,
          "created_at": "2025-09-02T18:02:40.412199+00:00",
          "updated_at": "2025-09-02T18:02:40.412199+00:00",
          "assigned_by": null,
          "assigned_at": "2025-09-04T11:16:33.476326+00:00",
          "expires_at": null
        },
        {
          "id": "187ec776-88ec-4e89-ae98-c4fe6d89b6b0",
          "user_id": "d691b0fd-6968-41f4-b307-233c2a2252c2",
          "role_id": "0494a795-762d-4426-9daf-5555a7986194",
          "is_active": false,
          "created_at": "2025-09-20T05:13:01.511975+00:00",
          "updated_at": "2025-09-20T05:13:01.621097+00:00",
          "assigned_by": null,
          "assigned_at": "2025-09-20T05:13:01.511975+00:00",
          "expires_at": null
        },
        {
          "id": "7e35f4e9-a3a4-4ecf-8203-f81b114454dc",
          "user_id": "d691b0fd-6968-41f4-b307-233c2a2252c2",
          "role_id": "9cc5563e-761f-4f6e-82a9-b9d534059ad0",
          "is_active": true,
          "created_at": "2025-09-16T20:35:29.967015+00:00",
          "updated_at": "2025-09-20T05:13:01.621097+00:00",
          "assigned_by": null,
          "assigned_at": "2025-09-16T20:35:29.578+00:00",
          "expires_at": null
        }
      ],
      "functions": [
        {
          "name": "is_admin",
          "definition": "CREATE OR REPLACE FUNCTION public.is_admin()\n RETURNS boolean\n LANGUAGE sql\n STABLE SECURITY DEFINER\n SET search_path TO 'public'\nAS $function$\n  select exists (\n    select 1 from public.user_roles ur\n    join public.roles r on r.id = ur.role_id\n    where ur.user_id = auth.uid() and ur.is_active and r.name='admin'\n  ) or exists (select 1 from public.profiles p where p.id=auth.uid() and p.is_admin);\n$function$\n"
        },
        {
          "name": "set_updated_at",
          "definition": "CREATE OR REPLACE FUNCTION public.set_updated_at()\n RETURNS trigger\n LANGUAGE plpgsql\n SET search_path TO 'pg_catalog', 'public'\nAS $function$\nbegin\n  new.updated_at := now();\n  return new;\nend$function$\n"
        }
      ]
    }
  }
]