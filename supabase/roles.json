[
  {
    "table_report": {
      "table": {
        "schema": "public",
        "name": "roles"
      },
      "columns": [
        {
          "column_name": "id",
          "data_type": "uuid",
          "is_nullable": "NO",
          "default": "gen_random_uuid()"
        },
        {
          "column_name": "name",
          "data_type": "text",
          "is_nullable": "NO",
          "default": null
        },
        {
          "column_name": "description",
          "data_type": "text",
          "is_nullable": "YES",
          "default": null
        },
        {
          "column_name": "created_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "NO",
          "default": "now()"
        },
        {
          "column_name": "updated_at",
          "data_type": "timestamp with time zone",
          "is_nullable": "NO",
          "default": "now()"
        },
        {
          "column_name": "display_name",
          "data_type": "text",
          "is_nullable": "NO",
          "default": null
        },
        {
          "column_name": "priority",
          "data_type": "integer",
          "is_nullable": "YES",
          "default": "0"
        },
        {
          "column_name": "is_active",
          "data_type": "boolean",
          "is_nullable": "NO",
          "default": "true"
        }
      ],
      "rls": {
        "rls_enabled": true,
        "rls_forced": false
      },
      "policies": [
        {
          "policyname": "roles_admin_all",
          "command": "ALL",
          "roles": [
            "authenticated"
          ],
          "using": "is_admin()",
          "with_check": "is_admin()"
        },
        {
          "policyname": "roles_select_public",
          "command": "SELECT",
          "roles": [
            "public"
          ],
          "using": "(((is_active = true) AND (name = ANY (ARRAY['visitor'::text, 'abonne'::text, 'free'::text, 'staff'::text]))) OR is_admin())",
          "with_check": null
        }
      ],
      "indexes": [
        {
          "name": "idx_roles_is_active",
          "def": "CREATE INDEX idx_roles_is_active ON public.roles USING btree (is_active) WHERE (is_active = true)"
        },
        {
          "name": "idx_roles_priority_name",
          "def": "CREATE INDEX idx_roles_priority_name ON public.roles USING btree (priority DESC, name)"
        },
        {
          "name": "roles_name_key",
          "def": "CREATE UNIQUE INDEX roles_name_key ON public.roles USING btree (name)"
        },
        {
          "name": "roles_pkey",
          "def": "CREATE UNIQUE INDEX roles_pkey ON public.roles USING btree (id)"
        }
      ],
      "constraints": [
        {
          "name": "roles_name_key",
          "type": "u",
          "definition": "UNIQUE (name)"
        },
        {
          "name": "roles_pkey",
          "type": "p",
          "definition": "PRIMARY KEY (id)"
        }
      ],
      "triggers": [
        {
          "name": "audit_roles_changes",
          "enabled": "O",
          "definition": "CREATE TRIGGER audit_roles_changes AFTER INSERT OR DELETE OR UPDATE ON roles FOR EACH ROW EXECUTE FUNCTION tg_audit_permission_change()",
          "function_name": "tg_audit_permission_change"
        },
        {
          "name": "prevent_system_role_deletion_trigger",
          "enabled": "O",
          "definition": "CREATE TRIGGER prevent_system_role_deletion_trigger BEFORE UPDATE ON roles FOR EACH ROW EXECUTE FUNCTION prevent_system_role_deletion()",
          "function_name": "prevent_system_role_deletion"
        },
        {
          "name": "set_roles_updated_at",
          "enabled": "O",
          "definition": "CREATE TRIGGER set_roles_updated_at BEFORE UPDATE ON roles FOR EACH ROW EXECUTE FUNCTION set_updated_at()",
          "function_name": "set_updated_at"
        }
      ],
      "data_preview": [
        {
          "id": "a45353be-c3df-481c-aec5-1878f781d712",
          "name": "staff",
          "description": "Personnel support et modération (rôle mixte)",
          "created_at": "2025-09-11T21:25:08.533245+00:00",
          "updated_at": "2025-09-11T21:25:08.533245+00:00",
          "display_name": "Support",
          "priority": 80,
          "is_active": true
        },
        {
          "id": "5d4e21cf-39f5-43f8-8ce6-6680f68f4d22",
          "name": "admin",
          "description": "Administrateur avec tous les droits",
          "created_at": "2025-09-02T17:43:25.330822+00:00",
          "updated_at": "2025-09-11T21:25:08.533245+00:00",
          "display_name": "admin",
          "priority": 100,
          "is_active": true
        },
        {
          "id": "0494a795-762d-4426-9daf-5555a7986194",
          "name": "abonne",
          "description": "Utilisateur abonné avec accès complet",
          "created_at": "2025-09-02T17:43:25.330822+00:00",
          "updated_at": "2025-09-11T21:25:08.533245+00:00",
          "display_name": "abonne",
          "priority": 50,
          "is_active": true
        },
        {
          "id": "9cc5563e-761f-4f6e-82a9-b9d534059ad0",
          "name": "free",
          "description": "Utilisateur avec compte gratuit limité par quotas",
          "created_at": "2025-09-11T21:25:08.533245+00:00",
          "updated_at": "2025-09-14T06:02:02.833768+00:00",
          "display_name": "Compte Gratuit",
          "priority": 20,
          "is_active": true
        },
        {
          "id": "ccaf8c2c-b694-4b93-a906-d37a2bc1a97f",
          "name": "visitor",
          "description": "Visiteur avec accès limité",
          "created_at": "2025-09-02T17:43:25.330822+00:00",
          "updated_at": "2025-09-14T06:02:21.60435+00:00",
          "display_name": "visitor",
          "priority": 10,
          "is_active": true
        }
      ],
      "functions": [
        {
          "name": "is_admin",
          "definition": "CREATE OR REPLACE FUNCTION public.is_admin()\n RETURNS boolean\n LANGUAGE sql\n STABLE SECURITY DEFINER\n SET search_path TO 'public'\nAS $function$\n  select exists (\n    select 1 from public.user_roles ur\n    join public.roles r on r.id = ur.role_id\n    where ur.user_id = auth.uid() and ur.is_active and r.name='admin'\n  ) or exists (select 1 from public.profiles p where p.id=auth.uid() and p.is_admin);\n$function$\n"
        },
        {
          "name": "set_updated_at",
          "definition": "CREATE OR REPLACE FUNCTION public.set_updated_at()\n RETURNS trigger\n LANGUAGE plpgsql\n SET search_path TO 'pg_catalog', 'public'\nAS $function$\nbegin\n  new.updated_at := now();\n  return new;\nend$function$\n"
        }
      ]
    }
  }
]